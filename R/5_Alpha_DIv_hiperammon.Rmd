---
title: "5_Alpha_DIv_hiperammon"
output: html_document
date: "2023-06-19"
---

```{r libraries and objects}
library("phyloseq"); packageVersion("phyloseq")
library(readr)
library(data.table)
library(ggpubr)
library("ggplot2"); packageVersion("ggplot2")
ps_0 <- readRDS("~/Documents/Lola/Datos_CIPF_2023/Rats_HE_HiperAmmon_model/outputs/ps_0.Rds")
```
#Alpha div plots groups

Alpha-diversity is calculated on the raw data, here data_otu or data_phylo if you are using phyloseq.
It is important to not use filtered data because many richness estimates are modeled on singletons and doubletons in the occurrence table. So, you need to leave them in the dataset if you want a meaningful estimate.
Moreover, we usually not using normalized data because we want to assess the diversity on the raw data and we are not comparing samples to each other but only assessing diversity within each sample.

```{r Counts}
reads_per_sample <- as.matrix(rowSums(t(as.data.frame(otu_table(ps_0)))))
reads_per_sample 
```


```{r Alpha Diversity}
newSTorder = c("Control", "Hiperammonemic")
my_comparisons <- list( c("Control", "Hiperammonemic"))
library(ggsignif)
#Observed
pObserved <- plot_richness(ps_0, x="Group", measures=c("Observed"))+
    geom_boxplot() + 
    geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
    theme_classic() + theme( legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 14)) + 
    stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pObserved$data$Group <- as.character(pObserved$data$Group)
pObserved$data$Group <- factor(pObserved$data$Group, levels=newSTorder)
pObserved$layers<-pObserved$layers[-1]
pObserved+ labs(color = "Group")

#Shannon
pShannon <- plot_richness(ps_0, x="Group", measures=c("Shannon")) +
  geom_boxplot(outlier.shape = NA) + 
    geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none",strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 14)) +
    stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pShannon$data$Group <- as.character(pShannon$data$Group)
pShannon$data$Group <- factor(pShannon$data$Group, levels=newSTorder)
pShannon$layers<-pShannon$layers[-1]
pShannon+ labs(color = "Group")


#Chao1
pChao <- plot_richness(ps_0, x="Group", measures=c("Chao1")) +
  geom_boxplot(outlier.shape = NA) + 
    geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 14)) +
    stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pChao$data$Group <- as.character(pChao$data$Group)
pChao$data$Group <- factor(pChao$data$Group, levels=newSTorder)
pChao$layers<-pChao$layers[-1]
pChao+ labs(color = "Group")

#Fisher
pFisher <- plot_richness(ps_0, x="Group", measures=c("Fisher")) +
  geom_boxplot(outlier.shape = NA) +geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 12), axis.title.y = element_text(size = 14)) +
    stat_compare_means(label= "p.signif", comparisons = my_comparisons)
pFisher$data$Group <- as.character(pFisher$data$Group)
pFisher$data$Group <- factor(pFisher$data$Group, levels=newSTorder)
pFisher$layers<-pFisher$layers[-1]
pFisher+ labs(color = "Group")

library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
grid.arrange(pFisher, pChao, pShannon, pObserved,nrow = 1)
```

#Alpha div plots batches
```{r Alpha Diversity batch}
newSTorder = c("B1", "B2", "B3")
my_comparisons <- list( c("B1", "B2"), c("B1", "B3"), c("B2", "B3"))
library(ggsignif)
#Observed
pObserved <- plot_richness(ps_0, x="Batch", measures=c("Observed"))+
  geom_boxplot() + 
  geom_jitter(aes(color = Batch), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme( legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 14), axis.title.y = element_blank()) + 
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pObserved$data$Batch <- as.character(pObserved$data$Batch)
pObserved$data$Batch <- factor(pObserved$data$Batch, levels=newSTorder)
pObserved$layers<-pObserved$layers[-1]
pObserved+ labs(color = "Batch")

#Shannon
pShannon <- plot_richness(ps_0, x="Batch", measures=c("Shannon")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Batch), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none",strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 14), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pShannon$data$Batch <- as.character(pShannon$data$Batch)
pShannon$data$Batch <- factor(pShannon$data$Batch, levels=newSTorder)
pShannon$layers<-pShannon$layers[-1]
pShannon+ labs(color = "Batch")


#Chao1
pChao <- plot_richness(ps_0, x="Batch", measures=c("Chao1")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Batch), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 14), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pChao$data$Batch <- as.character(pChao$data$Batch)
pChao$data$Batch <- factor(pChao$data$Batch, levels=newSTorder)
pChao$layers<-pChao$layers[-1]
pChao+ labs(color = "Batch")

#Fisher
pFisher <- plot_richness(ps_0, x="Batch", measures=c("Fisher")) +
  geom_boxplot(outlier.shape = NA) +geom_jitter(aes(color = Batch), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 14), axis.title.y = element_text(size = 16)) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
pFisher$data$Batch <- as.character(pFisher$data$Batch)
pFisher$data$Batch <- factor(pFisher$data$Batch, levels=newSTorder)
pFisher$layers<-pFisher$layers[-1]
pFisher+ labs(color = "Batch")

library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
grid.arrange(pFisher, pChao, pShannon, pObserved,nrow = 1)
```

#Alpha Diversity B1
```{r Alpha Diversity batch}
ps_B1 <- prune_samples(sample_data(ps_0)$Batch == "B1", ps_0)
newSTorder = c("Control", "Hiperammonemic")
my_comparisons <- list( c("Control", "Hiperammonemic"))
library(ggsignif)
#Observed
pObserved <- plot_richness(ps_B1, x="Group", measures=c("Observed"))+
  geom_boxplot() + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme( legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) + 
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pObserved$data$Group <- as.character(pObserved$data$Group)
pObserved$data$Group <- factor(pObserved$data$Group, levels=newSTorder)
pObserved$layers<-pObserved$layers[-1]
pObserved+ labs(color = "Group")

#Shannon
pShannon <- plot_richness(ps_B1, x="Group", measures=c("Shannon")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none",strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pShannon$data$Group <- as.character(pShannon$data$Group)
pShannon$data$Group <- factor(pShannon$data$Group, levels=newSTorder)
pShannon$layers<-pShannon$layers[-1]
pShannon+ labs(color = "Group")


#Chao1
pChao <- plot_richness(ps_B1, x="Group", measures=c("Chao1")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pChao$data$Group <- as.character(pChao$data$Group)
pChao$data$Group <- factor(pChao$data$Group, levels=newSTorder)
pChao$layers<-pChao$layers[-1]
pChao+ labs(color = "Group")

#Fisher
pFisher <- plot_richness(ps_B1, x="Group", measures=c("Fisher")) +
  geom_boxplot(outlier.shape = NA) +geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_text(size = 16)) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
pFisher$data$Group <- as.character(pFisher$data$Group)
pFisher$data$Group <- factor(pFisher$data$Group, levels=newSTorder)
pFisher$layers<-pFisher$layers[-1]
pFisher+ labs(color = "Group")

library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
grid.arrange(pFisher, pChao, pShannon, pObserved,nrow = 1)
```

#Alpha Diversity B2
```{r Alpha Diversity batch}
ps_B2 <- prune_samples(sample_data(ps_0)$Batch == "B2", ps_0)
newSTorder = c("Control", "Hiperammonemic")
my_comparisons <- list( c("Control", "Hiperammonemic"))
library(ggsignif)
#Observed
pObserved <- plot_richness(ps_B2, x="Group", measures=c("Observed"))+
  geom_boxplot() + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme( legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) + 
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pObserved$data$Group <- as.character(pObserved$data$Group)
pObserved$data$Group <- factor(pObserved$data$Group, levels=newSTorder)
pObserved$layers<-pObserved$layers[-1]
pObserved+ labs(color = "Group")

#Shannon
pShannon <- plot_richness(ps_B2, x="Group", measures=c("Shannon")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none",strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pShannon$data$Group <- as.character(pShannon$data$Group)
pShannon$data$Group <- factor(pShannon$data$Group, levels=newSTorder)
pShannon$layers<-pShannon$layers[-1]
pShannon+ labs(color = "Group")


#Chao1
pChao <- plot_richness(ps_B2, x="Group", measures=c("Chao1")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pChao$data$Group <- as.character(pChao$data$Group)
pChao$data$Group <- factor(pChao$data$Group, levels=newSTorder)
pChao$layers<-pChao$layers[-1]
pChao+ labs(color = "Group")

#Fisher
pFisher <- plot_richness(ps_B2, x="Group", measures=c("Fisher")) +
  geom_boxplot(outlier.shape = NA) +geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_text(size = 16)) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
pFisher$data$Group <- as.character(pFisher$data$Group)
pFisher$data$Group <- factor(pFisher$data$Group, levels=newSTorder)
pFisher$layers<-pFisher$layers[-1]
pFisher+ labs(color = "Group")

library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
grid.arrange(pFisher, pChao, pShannon, pObserved,nrow = 1)
```

#Alpha Diversity B3
```{r Alpha Diversity batch}
ps_B3 <- prune_samples(sample_data(ps_0)$Batch == "B3", ps_0)
newSTorder = c("Control", "Hiperammonemic")
my_comparisons <- list( c("Control", "Hiperammonemic"))
library(ggsignif)
#Observed
pObserved <- plot_richness(ps_B3, x="Group", measures=c("Observed"))+
  geom_boxplot() + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme( legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) + 
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pObserved$data$Group <- as.character(pObserved$data$Group)
pObserved$data$Group <- factor(pObserved$data$Group, levels=newSTorder)
pObserved$layers<-pObserved$layers[-1]
pObserved+ labs(color = "Group")

#Shannon
pShannon <- plot_richness(ps_B3, x="Group", measures=c("Shannon")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none",strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pShannon$data$Group <- as.character(pShannon$data$Group)
pShannon$data$Group <- factor(pShannon$data$Group, levels=newSTorder)
pShannon$layers<-pShannon$layers[-1]
pShannon+ labs(color = "Group")


#Chao1
pChao <- plot_richness(ps_B3, x="Group", measures=c("Chao1")) +
  geom_boxplot(outlier.shape = NA) + 
  geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_blank()) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
#Re-arranging the order of the figure, controls first
pChao$data$Group <- as.character(pChao$data$Group)
pChao$data$Group <- factor(pChao$data$Group, levels=newSTorder)
pChao$layers<-pChao$layers[-1]
pChao+ labs(color = "Group")

#Fisher
pFisher <- plot_richness(ps_B3, x="Group", measures=c("Fisher")) +
  geom_boxplot(outlier.shape = NA) +geom_jitter(aes(color = Group), position = position_jitterdodge(dodge.width = 0.65, jitter.width = 0.1, jitter.height = 0.1))+
  theme_classic() + theme(legend.position = "none", strip.background = element_blank(), axis.text.x.bottom = element_text(angle = 0), axis.text.x = element_text(size = 10), axis.title.y = element_text(size = 16)) +
  stat_compare_means(label= "p.signif", comparisons = my_comparisons)
pFisher$data$Group <- as.character(pFisher$data$Group)
pFisher$data$Group <- factor(pFisher$data$Group, levels=newSTorder)
pFisher$layers<-pFisher$layers[-1]
pFisher+ labs(color = "Group")

library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
grid.arrange(pFisher, pChao, pShannon, pObserved,nrow = 1)
```